/*! SuperLand 30-08-2014, (c) Hugo KELFANI */
var CassavaLight={exists:function(a){return void 0!==a&&null!==a},clone:function(a){var b,c,d,e;if(null===a||"object"!=typeof a)return a;if(a instanceof Date)return c=new Date,c.setTime(a.getTime()),c;if(a instanceof Array){for(c=[],d=0;d<a.length;++d)e=a[d],c[d]=this.clone(a[d]);return c}if(a instanceof Object){c={};for(b in a)a.hasOwnProperty(b)&&(c[b]=this.clone(a[b]));return c}throw"Unable to copy obj! Its type isn't supported."},intValue:function(a){return~~a},positiveIntValue:function(a){return a>=0?~~a:~~-a},Timer:function(){this.elapsed=0,this.last=null,this.tick=function(a){this.elapsed=(a-this.last)/1e3,this.last=a},this.fps=function(){return Math.round(1/this.elapsed)}}};!function(a){var b=function(b,c,d,e,f,g,h,i,j){this.x=b,this.y=c,this.z=d,this.width=e,this.height=f,this.rotation=g,this.sprite=h,this.spriteXDelta=i,this.spriteYDelta=j,this.setDatasFromObject=function(b){var c,d,e,f,g,h;for(c in b)if(f=b[c],"agent"===c){if(a.exists(f.x)&&(this.x=f.x),a.exists(f.y)&&(this.y=f.y),a.exists(f.sequence)&&a.exists(this.sprite)&&this.sprite.goToSequence(f.sequence),a.exists(f.states))for(h in f.states)g=f.states[h],this.states[h]=g}else for(d in f)e=f[d],this.reinitializeValue(c,d,e);return this},this.id=void 0,this.agentType=void 0,this.states={},this.modules={},this.model=void 0,this.solid=!1,this.toUpdate=!0,a.exists(this.sprite)&&this.sprite.setZIndex(this.z)};b.prototype.x2=function(){return this.x+this.width},b.prototype.y2=function(){return this.y+this.height},b.prototype.xCenter=function(){return this.x+this.width/2},b.prototype.yCenter=function(){return this.y+this.height/2},b.prototype.draw=function(){return a.exists(this.sprite)&&this.sprite.draw(),this},b.prototype.setID=function(b){return this.id=b,a.exists(this.sprite)&&this.sprite.setID(this.id),this},b.prototype.hasID=function(a){return this.id===a},b.prototype.getUniqueId=function(){return this.id},b.prototype.checkType=function(a){return this.agentType===a},b.prototype.set=function(b,c,d){if(!a.exists(this.modules[b]))throw"Module "+b+" not found";return this.modules[b].set(c,d),this},b.prototype.reinitializeValue=function(b,c,d){if(!a.exists(this.modules[b]))throw"Module "+b+" not found";return this.modules[b].reinitialize(c,d),this},b.prototype.get=function(b,c){if(a.exists(this.modules[b]))return this.modules[b].get(c);throw"Module "+b+" not found"},b.prototype.addModule=function(b){if("agent"===b)throw"Agent is a reserved name for modules";var c=new a.Module(b);return this.modules[c.name]=c,c.setAgent(this),c},b.prototype.giveState=function(a){return this.states[a]=!0,this},b.prototype.removeState=function(a){return this.states[a]=!1,this},b.prototype.clearStates=function(){for(var a in this.states)this.states[a]=!1;return this},b.prototype.hasState=function(a){return this.states[a]===!0},b.prototype.hasStates=function(a){var b,c=a.length;for(b=0;c>b;++b)if(this.states[a[b]]!==!0)return!1;return!0},b.prototype.update=function(){if(this.toUpdate||this.updateAnyways)for(var a in this.modules)void 0!==this.modules[a].update&&this.modules[a].update();return this},b.prototype.reset=function(){for(var a in this.modules)this.modules[a].reset();return this.clearStates(),this},b.prototype.free=function(){return this.model.removeAgent(this),this.model},b.prototype.enableSolid=function(){return this.solid=!0,this},b.prototype.isSolid=function(){return this.solid},b.prototype.getSpriteX=function(){return a.exists(this.sprite)?this.sprite.x:null},b.prototype.getSpriteY=function(){return a.exists(this.sprite)?this.sprite.y:null},b.prototype.goToSequence=function(a){return this.sprite.goToSequence(a),this.sprite},b.prototype.goToBeginningOfSequence=function(a){return this.sprite.goToBeginningOfSequence(a),this.sprite},b.prototype.setPosition=function(a,b){return this.x=a,this.y=b,this},a.Agent=b}(CassavaLight),function(a){var b=function(b,c,d,e){this.type=b,this.clusterSize=c,this.agentInitializer=d,this.model=e,this.cluster=void 0,this.idManager=new a.IdManager(this.type),this.modules={},this.isSolid=this.isAnimated=this.updateAnyways=!1};b.prototype.defineNewModule=function(a,b,c){return this.modules[a]={datas:b,update:c},this},b.prototype.defineSprite=function(a){return this.spriteInitializer=a,this},b.prototype.defineAgentDatas=function(a){return this.agentTemplate=a,this},b.prototype.enableAnimated=function(){return this.isAnimated=!0,this},b.prototype.enableSolid=function(){return this.isSolid=!0,this},b.prototype.enableUpdateAnyways=function(){return this.updateAnyways=!0,this},b.prototype.init=function(b){var c,d,e,f,g;if(a.exists(b)||(b=[]),!a.exists(this.agentTemplate))throw"agentInitializer has not been defined";for(d=0;d<this.clusterSize-(this.checkPool(b)?b.length:0);++d){a.exists(this.spriteInitializer)&&(g=this.model.getNewSprite(this.spriteInitializer.spriteSheet,this.spriteInitializer.spriteWidth*this.spriteInitializer.numberOfFrames,this.spriteInitializer.spriteHeight,a.exists(this.spriteInitializer.sequences)?this.spriteInitializer.sequences:{},this.spriteInitializer.numberOfFrames,this.spriteInitializer.frameTTL)),c=new a.Agent(this.agentTemplate.x,this.agentTemplate.y,this.agentTemplate.z,this.agentTemplate.width,this.agentTemplate.height,this.agentTemplate.rotation,g,this.agentTemplate.spriteXDelta,this.agentTemplate.spriteYDelta);for(f in this.modules)e=this.modules[f],c.addModule(f).withDatas(e.datas).whichUpdatesWith(e.update);this.isSolid&&c.enableSolid(),c.updateAnyways=this.updateAnyways,this.isAnimated&&g.play(),c.agentType=this.type,this.clusterSize>1?(a.exists(this.cluster)||(this.cluster=new a.LinkedList),c.setID(this.idManager.getNewID()),this.cluster.add(c)):(c.setID(this.type),this.cluster=c)}for(d=0;d<b.length;++d)c=b[d],this.clusterSize>1?this.cluster.add(c):1!==b.lenghth||a.exists(this.cluster)||(this.cluster=c);return this},b.prototype.free=function(a){return this.clusterSize>1?this.cluster.has(a)||this.cluster.add(a):this.cluster=a,this},b.prototype.createAgent=function(a){var b;if(this.clusterSize>1&&this.cluster.isEmpty()||"undefined"==typeof this.cluster)throw"Factory "+this.type+" is empty !";return this.clusterSize>1?b=this.cluster.pop():(b=this.cluster,this.cluster=void 0),b.reset(),this.agentInitializer(b,a),b},b.prototype.checkPool=function(a){var b,c;if(0===a.length)return!1;for(c=0;c<a.length;c++)if(b=a[c],b.agentType!==this.type)return!1;return!0},b.prototype.gameGet=function(a){return this.model.game.get(a)},b.prototype.gameSet=function(a,b){this.model.game.set(a,b)},a.AgentFactory=b}(CassavaLight),function(a){var b=function(a,b,c){this.model=a,this.sceneWidth=b,this.sceneHeight=c,this.x=this.y=this.displayX=this.displayY=0,this.logicScope={width:0,height:0,xDelta:0,yDelta:0},this.displayScope={width:0,height:0,xDelta:0,yDelta:0}};b.prototype.setLogicDomainScale=function(b){var c=Math.sqrt(b);return this.logicScope.width=a.intValue(this.sceneWidth*c),this.logicScope.height=a.intValue(this.sceneHeight*c),this.logicScope.xDelta=this.x+a.intValue((this.sceneWidth-this.logicScope.width)/2),this.logicScope.yDelta=this.y+a.intValue((this.sceneHeight-this.logicScope.height)/2),this},b.prototype.setDisplayDomainScale=function(b){var c=Math.sqrt(b);return this.displayScope.width=a.intValue(this.sceneWidth*c),this.displayScope.height=a.intValue(this.sceneHeight*c),this.displayScope.xDelta=a.intValue((this.sceneWidth-this.displayScope.width)/2),this.displayScope.yDelta=a.intValue((this.sceneHeight-this.displayScope.height)/2),this},b.prototype.goTo=function(a,b){return this.x=a,this.y=b,this},b.prototype.draw=function(){var b,c,d,e,f;for(f in this.model.agents)for(b=this.model.agents[f].firstNode;null!==b;)c=b.o,a.exists(c.sprite)&&(c.sprite.setPosition(c.x+c.spriteXDelta-this.x,c.y+c.spriteYDelta-this.y),c.sprite.setInScope(this.isAgentIsInScope(c,this.displayScope)?!0:!1),c.updateAnyWays||(c.toUpdate=this.isAgentIsInScope(c,this.logicScope)?!0:!1)),b=b.next;if(a.exists(this.model.grid))for(var g=0;g<this.model.grid.logicTiles.length;++g)e=this.model.grid.logicTiles[g],d=this.model.grid.spritesTiles[g],null!==d&&(d.setPosition(e.x-this.x,e.y-this.y),d.setInScope(this.isTileIsInScope(e,this.displayScope)?!0:!1));return this},b.prototype.isTileIsInScope=function(a,b){return this.y+b.yDelta+b.height<a.y||this.y+b.yDelta>a.y2||this.x+b.xDelta>a.x2||this.x+b.xDelta+b.width<a.x?!1:!0},b.prototype.isAgentIsInScope=function(a,b){return this.y+b.yDelta+b.height<a.y||this.y+b.yDelta>a.y2()||this.x+b.xDelta>a.x2()||this.x+b.xDelta+b.width<a.x?!1:!0},a.Camera=b}(CassavaLight),function(a){var b=function(b,c){this.stageWidth=b,this.stageHeight=c,this.stage=document.createElement("canvas"),this.context=this.stage.getContext("2d"),this.color="#000000",this.stage.style.position="relative",this.stage.width=this.stageWidth,this.stage.height=this.stageHeight,this.awakenSpritesLists=[],this.sleepingSprites=new a.LinkedList,this.resourcesBuffer={},document.body.appendChild(this.stage)};b.prototype.setStageStyle=function(a,b){return"color"===a&&(this.color=b),this},b.prototype.loadImage=function(b){var c;return a.exists(this.resourcesBuffer[b])||(c=new Image,c.src=b,this.resourcesBuffer[b]=new Image,this.resourcesBuffer[b].src=b),this},b.prototype.draw=function(){var b,c,d,e,f,g,h;if(!a.exists(this.model))throw"model not defined";for(e=this.model.removedAgentsSprites.firstNode;null!=e;){for(this.sleepingSprites.remove(e.o),h=0;h<this.awakenSpritesLists.length;h++)b=this.awakenSpritesLists[h],null!=b&&b.remove(e.o);e=e.next}for(e=this.model.addedAgentsSprites.firstNode;null!=e;)this.sleepingSprites.add(e.o),e=e.next;this.model.clearGraphicCache(),a.exists(this.model.grid)&&this.model.grid.draw();for(d in this.model.agents)for(e=this.model.agents[d].firstNode;null!==e;)e.o.draw(),e=e.next;if(c=this.model.camera,null!=c){for(c.draw(),h=0;h<this.awakenSpritesLists.length;h++)if(b=this.awakenSpritesLists[h],null!=b)for(f=b.firstNode;f;)g=f.o,f=f.next,g.isInScope||(this.sleepingSprites.add(g),b.remove(g));for(f=this.sleepingSprites.firstNode;f;)g=f.o,f=f.next,g.isInScope&&(this.addAwakenSprite(g),this.sleepingSprites.remove(g))}return this.render(),this},b.prototype.getNewSprite=function(b,c,d,e,f,g){return a.exists(e)||(e={}),this.loadImage(b),new a.SpriteCanvas(b,c,d,e,f,g)},b.prototype.render=function(){var b,c,d,e;for(this.context.fillStyle=this.color,this.context.fillRect(0,0,this.stageWidth,this.stageWidth),e=0;e<this.awakenSpritesLists.length;e++)if(b=this.awakenSpritesLists[e],a.exists(b))for(c=b.firstNode;null!==c;)d=c.o,this.context.drawImage(this.resourcesBuffer[d.spriteSheet],d.imagePointerX,0,d.width,d.height,d.x,d.y,d.width,d.height),c=c.next;return this},b.prototype.setModel=function(a){return this.model=a,this.model.setGraphicEngine(this),this.clear(),this},b.prototype.clear=function(){var b,c;for(c=0;c<this.awakenSpritesLists.length;c++)b=this.awakenSpritesLists[c],a.exists(b)&&b.clear();return this.sleepingSprites.clear(),this},b.prototype.addAwakenSprite=function(b){return a.exists(this.awakenSpritesLists[b.z])||(this.awakenSpritesLists[b.z]=new a.LinkedList),this.awakenSpritesLists[b.z].add(b),this},a.CanvasGraphicEngine=b}(CassavaLight),function(a){var b=function(a,b){this.model=a,this.caseSide=b,this.height=this.model.height,this.width=this.model.width,this.numberOfCasesOnWidth=this.model.width/this.caseSide,this.numberOfCasesOnHeight=this.model.height/this.caseSide,this.grid=[],this.tileGrid=void 0,this.mapGrid=[],this.initGrid()};b.prototype.initGrid=function(){var b,c;for(b=0;b<this.numberOfCasesOnWidth;++b)for(this.grid[b]=[],this.mapGrid[b]=[],c=0;c<this.numberOfCasesOnHeight;++c)this.grid[b][c]=new a.LinkedList,this.mapGrid[b][c]=new a.LinkedList;return this},b.prototype.loadLevel=function(b){var c,d,e,f;this.tileGrid=b;for(d in this.tileGrid.logicTiles)if(f=this.tileGrid.logicTiles[d],f.solid)for(c=f.x-f.x%this.caseSide;c<f.x2&&c<this.width;){for(e=f.y-f.y%this.caseSide;e<f.y2&&e<this.height;)this.mapGrid[a.positiveIntValue(c/this.caseSide)][a.positiveIntValue(e/this.caseSide)].add(new a.IdentifiableObject(d)),e+=this.caseSide;c+=this.caseSide}return this},b.prototype.update=function(){var b,c,d,e,f;this.clearGrid();for(f in this.model.agents)for(c=this.model.agents[f].firstNode;null!==c;){if(b=c.o,b.isSolid())for(d=b.x-b.x%this.caseSide;d<b.x+b.width&&d<this.width;){for(e=b.y-b.y%this.caseSide;e<b.y+b.height&&e<this.height;)this.grid[a.positiveIntValue(d/this.caseSide)][a.positiveIntValue(e/this.caseSide)].add(b),e+=this.caseSide;d+=this.caseSide}c=c.next}return this},b.prototype.testCollision=function(a,b){var c,d,e;for(c=0;c<this.numberOfCasesOnWidth;++c)for(d=0;d<this.numberOfCasesOnHeight;++d)if(this.grid[c][d].has(a)&&this.grid[c][d].has(b)&&(e=this.testBoxesCollisionWithAgent(a,b)))return!0;return!1},b.prototype.testTilesCollision=function(a,b,c){var d,e,f,g,h,i,j;for(length=b.length,d=!1,e=0;e<this.numberOfCasesOnWidth;++e)for(f=0;f<this.numberOfCasesOnHeight;++f)if(this.grid[e][f].has(a))for(j=this.mapGrid[e][f].firstNode;j;){for(i=j.o.getUniqueId(),g=0;length>g;++g)this.tileGrid.getTileByIndex(i)===b[g]&&(h=this.tileGrid.getLogicTileByIndex(i),this.testBoxesCollisionWithTile(a,h)&&(c.push(h),d=!0));j=j.next}return d},b.prototype.clearGrid=function(){var a,b;for(a=0;a<this.numberOfCasesOnWidth;++a)for(b=0;b<this.numberOfCasesOnHeight;++b)this.grid[a][b].clear();return this},b.prototype.testBoxesCollisionWithAgent=function(a,b){return a.y+a.height<=b.y||a.y>=b.y+b.height||a.x>=b.x+b.width||a.x+a.width<=b.x?!1:!0},b.prototype.testBoxesCollisionWithTile=function(a,b){return a.y+a.height<=b.y||a.y>=b.y2||a.x>=b.x2||a.x+a.width<=b.x?!1:!0},a.CollisionChecker=b}(CassavaLight),function(a){var b=function(b,c){this.sceneWidth=b,this.sceneHeight=c,this.parser=new a.ModelParser,this.currentModel=void 0,this.loadedModel=void 0,this.modelsConfigs={},this.isRunning=!1,this.graphicEngine=void 0,this.logicEngine=new a.LogicEngine,this.debug=!1,this.gameState={}};b.prototype.addModelConfig=function(a,b){return this.modelsConfigs[a]=b,this},b.prototype.initState=function(b){return this.gameState=a.clone(b),this},b.prototype.set=function(a,b){return this.gameState[a]=b,this},b.prototype.get=function(a){return this.gameState[a]},b.prototype.init=function(){return this.graphicEngine.setModel(this.currentModel),this.logicEngine.setModel(this.currentModel),this},b.prototype.loadModel=function(b,c){var d=this.currentModel;return this.config=a.clone(this.modelsConfigs[b]),this.currentModel=this.parser.loadModel(this.graphicEngine,this.config,c,this),void 0!==d&&(this.currentModel.keysListener=d.keysListener),this.init()},b.prototype.defineGraphicEngine=function(b){if("canvas"!==b)throw"Graphic engine type does not exist";return this.graphicEngine=new a.CanvasGraphicEngine(this.sceneWidth,this.sceneHeight),this},b.prototype.run=function(){var b,c=this;if(this.isRunning=!0,this.debug){var d=new a.Timer,e=0,f=document.createElement("div");document.body.appendChild(f);var g=document.createElement("div");document.body.appendChild(g)}window.logInDebugger=function(a){c.debug&&(g.innerHTML=g.innerHTML+a+"<br/>")},(b=function(a){return requestAnimationFrame(b),c.debug&&(d.tick(a),a-e>1e3&&(e=a,f.innerHTML="fps:"+d.fps()),g.innerHTML=""),c.isRunning&&(c.graphicEngine.draw(),c.logicEngine.update()),null})()},a.Game=b}(CassavaLight),function(a){var b=function(a){this.name=a,this.currentId=0};b.prototype.getNewID=function(){return this.name+"_"+this.currentId++},a.IdManager=b}(CassavaLight),function(a){var b=function(){var a=this;this.pushed=[],window.addEventListener("keydown",function(b){a.pushed[b.keyCode]=!0}),window.addEventListener("keyup",function(b){a.pushed[b.keyCode]=!1})};b.prototype.getKeyPushed=function(a){return this.pushed[a]===!0},a.KeysListener=b}(CassavaLight),function(a){var b=function(){this.firstNode=null,this.lastNode=null,this.map={},this.pool=[]};b.prototype.add=function(a){var b;return b=0===this.pool.length?new c(a,this):this.pool.pop().reset(a),null===this.firstNode?this.firstNode=this.lastNode=b:(this.lastNode.push(b),this.lastNode=b),this.map[a.getUniqueId()]=b,this},b.prototype.pop=function(){if(this.isEmpty())return null;var a=this.firstNode.o;return this.remove(a),a},b.prototype.free=function(a){return a===this.firstNode&&(this.firstNode=a.next),a===this.lastNode&&(this.lastNode=a.pred),this.map[a.o.getUniqueId()]=void 0,this.pool.push(a),a.o},b.prototype.remove=function(a){void 0!==this.map[a.getUniqueId()]&&(this.map[a.getUniqueId()].remove(a.getUniqueId()),this.map[a.getUniqueId()]=void 0)},b.prototype.has=function(a){return null!==this.firstNode?void 0!==this.map[a.getUniqueId()]:!1},b.prototype.log=function(){return this.map},b.prototype.clear=function(){for(var a=this.firstNode;null!==a;)this.free(a),a=a.next;this.firstNode=null,this.lastNode=null},b.prototype.get=function(a){return null!==this.map[a]&&void 0!==this.map[a]?this.map[a].o:null},b.prototype.isEmpty=function(){return null===this.firstNode},a.LinkedList=b;var c=function(a,b){this.o=a,this.next=null,this.pred=null,this.linkedList=b};c.prototype.reset=function(a){return this.o=a,this.pred=null,this.next=null,this},c.prototype.push=function(a){null===this.next?(this.next=a,a.pred=this):this.next.push(a)},c.prototype.remove=function(a){this.o.getUniqueId()===a?(this.linkedList.free(this),null!==this.pred&&(this.pred.next=this.next),null!==this.next&&(this.next.pred=this.pred)):null!==this.next&&this.next.remove(a)},c.prototype.has=function(a){return this.o.getUniqueId()===a?!0:null!==this.next?this.next.has(a):!1},c.prototype.log=function(a){a.push(this.o),null!==this.next&&this.next.log(a)},c.prototype.clear=function(){null!==this.next&&this.next.clear(),this.linkedList.free(this)},c.prototype.get=function(a){return this.o.getUniqueId()===a?this.o:null!==this.next?this.next.get(a):null},a.LinkedNode=c;var d=function(a){this.id=a};d.prototype.getUniqueId=function(){return this.id},a.IdentifiableObject=d}(CassavaLight),function(a){var b=function(){};b.prototype.update=function(){var b;if(!a.exists(this.model))throw"Model is not defined";b=this.model,this.updateAgents(),this.model===b&&(this.model.applyRules().refreshRules(),this.model===b&&("undefined"!=typeof this.model.postEventsHandler&&this.model.postEventsHandler.update(),this.model===b&&this.model.updateCollisionsChecker().clearLogicCache()))},b.prototype.setModel=function(a){this.model=a},b.prototype.updateAgents=function(){var a,b;for(b in this.model.agents)for(a=this.model.agents[b].firstNode;null!==a;)a.o.update(),a=a.next},a.LogicEngine=b}(CassavaLight),function(a){var b=function(){this.name="",this.keysListener=new a.KeysListener,this.collisionsChecker=null,this.width=this.height=this.tileSide=0,this.removedAgentsSprites=new a.LinkedList,this.addedAgentsSprites=new a.LinkedList,this.agents={},this.removedAgents=[],this.addedAgents=[],this.factories={},this.grid=void 0,this.events=[],this.game=void 0,this.camera=void 0};b.prototype.setName=function(a){return this.name=a,this},b.prototype.getName=function(){return this.name},b.prototype.initCamera=function(){return this.camera=new a.Camera(this,this.game.sceneWidth,this.game.sceneHeight)},b.prototype.initEnvironment=function(b,c,d,e,f,g,h,i){return this.grid=new a.TilesGrid(this),this.grid.withWidth(b).withTilesTypes(c).withSequences(d).withSpriteSheet(e).withTotalFrames(f).withTileWidth(g).withTileHeight(h).withFrameTTL(i),this},b.prototype.loadLevel=function(b){if(!a.exists(this.grid))throw"Grid has not been initialized";return this.grid.initGrid(b),a.exists(this.collisionsChecker)&&this.collisionsChecker.loadLevel(this.grid),this},b.prototype.addFactory=function(b){return this.factories[b.type]=b,this.agents[b.type]=new a.LinkedList,this.addedAgents[b.type]=new a.LinkedList,this.removedAgents[b.type]=new a.LinkedList,this},b.prototype.addFactories=function(b){var c,d;for(d=0;d<b.length;d++)c=b[d],this.factories[c.type]=c,this.agents[c.type]=new a.LinkedList,this.addedAgents[c.type]=new a.LinkedList,this.removedAgents[c.type]=new a.LinkedList;return this},b.prototype.addAgent=function(b){return a.exists(b)&&(b.model=this,a.exists(this.agents[b.agentType])||(this.agents[b.agentType]=new a.LinkedList),a.exists(this.addedAgents[b.agentType])||(this.addedAgents[b.agentType]=new a.LinkedList),this.agents[b.agentType].add(b),this.addedAgents[b.agentType].add(b),a.exists(b.sprite)&&this.addedAgentsSprites.add(b.sprite)),this},b.prototype.createAgent=function(b,c){if(!a.exists(this.factories[b]))throw"Factory "+b+" does not exist.";return this.addAgent(this.factories[b].createAgent(c)),this},b.prototype.removeAgent=function(b){var c=b.agentType;return a.exists(this.agents[c])||(this.agents[c]=new a.LinkedList),a.exists(this.removedAgents[c])||(this.removedAgents[c]=new a.LinkedList),this.agents[c].remove(b),this.removedAgents[c].add(b),a.exists(b.sprite)&&this.removedAgentsSprites.add(b.sprite),a.exists(this.factories[c])&&this.factories[c].free(b),this},b.prototype.initCollisionsChecker=function(b,c,d){return this.width=b,this.height=c,this.collisionsChecker=new a.CollisionChecker(this,d),this},b.prototype.updateCollisionsChecker=function(){return a.exists(this.collisionsChecker)&&this.collisionsChecker.update(),this},b.prototype.clearGraphicCache=function(){return this.removedAgentsSprites.clear(),this.addedAgentsSprites.clear(),this},b.prototype.clearLogicCache=function(){var a;for(a in this.removedAgents)this.removedAgents[a].clear();for(a in this.addedAgents)this.addedAgents[a].clear();return this},b.prototype.updateLogicBuffer=function(a,b){var c,d,e=b.length;for(d=0;e>d;++d)if(void 0!==this.agents[b[d]]){for(c=this.addedAgents[b[d]].firstNode;null!==c;)a.add(c.o),c=c.next;for(c=this.removedAgents[b[d]].firstNode;null!==c;)a.remove(c.o),c=c.next}return this},b.prototype.getAgentsByType=function(a){return this.agents[a]},b.prototype.getAgentById=function(a){var b,c;for(c in this.agents)if(b=this.agents[c].get(a),null!==b)return b;return null},b.prototype.isKeyPressed=function(a){return this.keysListener.getKeyPushed(a)},b.prototype.agentsCollide=function(a,b){return this.collisionsChecker.testCollision(a,b)},b.prototype.agentHitsTiles=function(a,b,c){return this.collisionsChecker.testTilesCollision(a,b,c)},b.prototype.setGraphicEngine=function(a){return this.graphicEngine=a,this},b.prototype.getNewSprite=function(b,c,d,e,f,g){return a.exists(e)||(e={}),this.graphicEngine.getNewSprite(b,c,d,e,f,g)},b.prototype.bind=function(b,c,d){var e;return"key"===b&&(e=new a.RuleKey(c.key,this),null!=c.agents?e.isPressedSo(c.agents).will(d):e.will(d)),"agentHitsAgent"===b&&(e=new a.RuleCollision(c.firstAgents,c.secondAgents,this),e.so(d)),"agentHitsTile"===b&&(e=new a.RuleTileCollision(this),e.withAgentTypes(c.agents).withTiles(c.tiles).so(d)),"newFrame"===b&&(e=new a.RuleNewFrame(this,d)),a.exists(e)&&this.events.push(e),this},b.prototype.applyRules=function(){var a;for(a=0;a<this.events.length;a++)this.events[a].apply();return this},b.prototype.refreshRules=function(){var a;for(a=0;a<this.events.length;a++)this.events[a].refresh();return this},b.prototype.goToModel=function(a,b){return this.game.loadModel(a,b)},b.prototype.setInPostEvents=function(a,b,c){return this.postEventsHandler.set(a,b,c),this},b.prototype.getInPostEvents=function(a,b){return this.postEventsHandler.get(a,b)},a.Model=b}(CassavaLight),function(a){var b=function(){};b.prototype.loadModel=function(b,c,d,e){var f;if(this.transferredDatas=d,this.model=new a.Model,this.model.game=e,this.model.setGraphicEngine(b),a.exists(this.transferredDatas)&&(this.transferredAgents=this.organizeTransferredAgentsByType()),!a.exists(c.name))throw"name is not defined";if(this.model.setName(c.name),!a.exists(c.camera))throw"camera config not defined";if(this.initCamera(c.camera),a.exists(c.collisionsChecker)&&this.initCollisionsChecker(c.collisionsChecker),a.exists(c.gridConfig)&&(this.initGridConfig(c.gridConfig),a.exists(c.grid)&&this.initGrid(c.grid)),a.exists(c.agents)&&(this.initAgents(c.agents),a.exists(c.defaultAgents)&&this.initDefaultAgents(c.defaultAgents)),a.exists(c.events)&&this.initEvents(c.events),this.initModel(c.init),this.transferredDatas=void 0,a.exists(c.postEventsModules)){this.model.postEventsHandler=new a.Agent,this.model.postEventsHandler.model=this.model;for(f in c.postEventsModules)this.model.postEventsHandler.addModule(f).withDatas(c.postEventsModules[f].datas).whichUpdatesWith(c.postEventsModules[f].update)}return this.model},b.prototype.initCamera=function(b){if(!a.exists(b.modelInitialPosition))throw"camera.modelInitialPosition not defined";if(!a.exists(b.modelInitialPosition.x))throw"camera.modelInitialPosition.x not defined";if(!a.exists(b.modelInitialPosition.y))throw"camera.modelInitialPosition.Y not defined";this.model.initCamera().setDisplayDomainScale(b.displayDomainScale||1).setLogicDomainScale(b.logicDomainScale||1).goTo(this.transferredDatas&&this.transferredDatas.camera&&null!=this.transferredDatas.camera.x?this.transferredDatas.camera.x:b.modelInitialPosition.x,this.transferredDatas&&this.transferredDatas.camera&&null!=this.transferredDatas.camera.y?this.transferredDatas.camera.y:b.modelInitialPosition.y)},b.prototype.initCollisionsChecker=function(b){if(!a.exists(b.width))throw"collisionChecker.width not defined";if(!a.exists(b.height))throw"collisionChecker.height not defined";if(!a.exists(b.tileSide))throw"collisionChecker.tileSide not defined";this.model.initCollisionsChecker(b.width,b.height,b.tileSide)},b.prototype.initGridConfig=function(b){if(!a.exists(b.width))throw"gridConfig.width not defined";if(!a.exists(b.tilesTypes))throw"gridConfig.tilesTypes not defined";if(!a.exists(b.sprite.sequences))throw"gridConfig.sequences not defined";if(!a.exists(b.sprite.spriteSheet))throw"gridConfig.spriteSheet not defined";if(!a.exists(b.sprite.numberOfFrames))throw"gridConfig.numberOfFramesFrames not defined";if(!a.exists(b.sprite.spriteWidth))throw"gridConfig.spriteWidth not defined";if(!a.exists(b.sprite.spriteHeight))throw"gridConfig.spriteHeight not defined";if(!a.exists(b.sprite.frameTTL))throw"gridConfig.frameTTL not defined";this.model.initEnvironment(b.width,b.tilesTypes,b.sprite.sequences,b.sprite.spriteSheet,b.sprite.numberOfFrames,b.sprite.spriteWidth,b.sprite.spriteHeight,b.sprite.frameTTL),a.exists(b.adapter)&&this.model.grid.withAdapter(b.adapter)},b.prototype.initGrid=function(a){this.model.loadLevel(a)},b.prototype.initAgents=function(b){var c,d,e,f,g;for(g in b){if(c=b[g],!a.exists(c.number))throw"agents.number not defined";if(!a.exists(c.initMethod))throw"agents.initMethod not defined";if(!a.exists(c.animated))throw"agents.animated not defined";if(!a.exists(c.solid))throw"agents.solid not defined";if(!a.exists(c.datas))throw"agents.datas";if(!a.exists(c.modules))throw"agents.modules not defined";d=new a.AgentFactory(g,c.number,c.initMethod,this.model);for(f in c.modules)e=c.modules[f],d.defineNewModule(f,e.datas,e.update);d.defineSprite(c.sprite).defineAgentDatas(c.datas),c.animated&&d.enableAnimated(),c.solid&&d.enableSolid(),c.updateAnyways&&d.enableUpdateAnyways(),d.init(null!=this.transferredAgents?this.transferredAgents[g]:void 0),this.model.addFactory(d)}},b.prototype.initDefaultAgents=function(b){var c,d,e,f,g;for(f=0;f<b.length;f++){if(d=b[f],!a.exists(d.agentType))throw"agentState.agentType not defined";if(!a.exists(d.datas))throw"agentState.datas not defined";if(e=!1,null!=this.transferredDatas&&d.notMandatory)for(g=0;g<this.transferredDatas.agents.length;g++)if(c=this.transferredDatas.agents[g],!c.got&&c.ref.agentType===d.agentType){c.got=!0,e=!0,c.ref.setDatasFromObject(c.newDatas),this.model.addAgent(c.ref);break}e||this.model.createAgent(d.agentType,d.datas)}},b.prototype.initEvents=function(b){var c,d;for(d=0;d<b.length;d++){if(c=b[d],!a.exists(c.type))throw"event.type not defined";if(!a.exists(c.parameters))throw"event.parameters not defined";if(!a.exists(c.callback))throw"event.callback not defined";this.model.bind(c.type,c.parameters,c.callback)}},b.prototype.initModel=function(a){a.initFunction(this.model)},b.prototype.organizeTransferredAgentsByType=function(){var a,b;for(this.pools={},b=0;b<this.transferredDatas.agents.length;b++)a=this.transferredDatas.agents[b],null==this.pools[a.ref.agentType]&&(this.pools[a.ref.agentType]=[]),this.pools[a.ref.agentType].push(a.ref);return this},a.ModelParser=b}(CassavaLight),function(a){var b=function(a){this.name=a,this.agent=void 0,this.possibleStates=void 0,this.update=void 0,this.datas=void 0,this.datasInitialValues=void 0};b.prototype.withStates=function(a){var b,c;for(this.possibleStates=a,c=0;c<this.possibleStates.length;c++)b=this.possibleStates[c],this.agent.removeState(b);return this},b.prototype.whichUpdatesWith=function(a){return this.update=a,this},b.prototype.withDatas=function(b){return this.datas=a.clone(b),this.datasInitialValues=a.clone(b),this},b.prototype.setAgent=function(a){return this.agent=a,this.model=this.agent.model,this},b.prototype.get=function(a){return this.datas[a]},b.prototype.set=function(a,b){return this.datas[a]=b,this},b.prototype.reinitialize=function(b,c){return this.datas[b]=c,this.datasInitialValues[b]=a.clone(c),this},b.prototype.reset=function(){var a,b;for(b in this.datas)a=this.datas[b],this.datas[b]=this.datasInitialValues[b];return this},b.prototype.getUniqueId=function(){return this.name},b.prototype.createAgent=function(a,b){this.agent.model.createAgent(a,b)},b.prototype.setTile=function(a,b){this.agent.model.grid.setTile(a,b)},b.prototype.goToModel=function(a,b){this.agent.model.goToModel(a,b)},b.prototype.getAgentById=function(a){return this.agent.model.getAgentById(a)},b.prototype.camera=function(){return this.agent.model.camera},b.prototype.gameGet=function(a){return this.agent.model.game.get(a)},b.prototype.gameSet=function(a,b){this.agent.model.game.set(a,b)},b.prototype.getInPostEvents=function(a,b){return this.agent.model.getInPostEvents(a,b)},b.prototype.setInPostEvents=function(a,b,c){return this.agent.model.setInPostEvents(a,b,c),this},b.prototype.getModel=function(){return this.agent.model},a.Module=b}(CassavaLight),function(a){var b=function(b,c,d){this.firstAgentTypes=b,this.secondAgentTypes=c,this.model=d,this.id=void 0,this.firstAgents=new a.LinkedList,this.secondAgents=new a.LinkedList,this.functionToApply=void 0};b.prototype.createAgent=function(a,b){this.model.createAgent(a,b)},b.prototype.setTile=function(a,b){this.model.grid.setTile(a,b)},b.prototype.goToModel=function(a,b){this.model.goToModel(a,b)},b.prototype.getAgentById=function(a){return this.model.getAgentById(a)},b.prototype.gameGet=function(a){return this.model.game.get(a)},b.prototype.gameSet=function(a,b){this.model.game.set(a,b)},b.prototype.getInPostEvents=function(a,b){return this.model.getInPostEvents(a,b)},b.prototype.setInPostEvents=function(a,b,c){return this.model.setInPostEvents(a,b,c),this},b.prototype.so=function(a){return this.functionToApply=a,this},b.prototype.refresh=function(){return this.model.updateLogicBuffer(this.firstAgents,this.firstAgentTypes),this.model.updateLogicBuffer(this.secondAgents,this.secondAgentTypes),this},b.prototype.apply=function(){var a,b;for(a=this.firstAgents.firstNode;null!==a;){for(b=this.secondAgents.firstNode;null!==b;)this.model.agentsCollide(a.o,b.o)&&this.functionToApply(a.o,b.o),b=b.next;a=a.next}return this},b.prototype.setID=function(a){return this.id=a,this},b.prototype.getUniqueId=function(){return this.id},a.RuleCollision=b}(CassavaLight),function(a){var b=function(b,c){this.key=b,this.model=c,this.id=this.concernedTypes=this.functionToApply=void 0,this.concernedAgents=new a.LinkedList};b.prototype.createAgent=function(a,b){this.model.createAgent(a,b)},b.prototype.setTile=function(a,b){this.model.grid.setTile(a,b)},b.prototype.goToModel=function(a,b){this.model.goToModel(a,b)},b.prototype.getAgentById=function(a){return this.model.getAgentById(a)},b.prototype.gameGet=function(a){return this.model.game.get(a)},b.prototype.gameSet=function(a,b){this.model.game.set(a,b)},b.prototype.getInPostEvents=function(a,b){return this.model.getInPostEvents(a,b)
},b.prototype.setInPostEvents=function(a,b,c){return this.model.setInPostEvents(a,b,c),this},b.prototype.isPressedSo=function(a){return this.concernedTypes=a,this},b.prototype.will=function(a){return this.functionToApply=a,this},b.prototype.refresh=function(){return a.exists(this.concernedTypes)&&this.model.updateLogicBuffer(this.concernedAgents,this.concernedTypes),this},b.prototype.apply=function(){var b;if(this.model.isKeyPressed(this.key))if(a.exists(this.concernedTypes))for(b=this.concernedAgents.firstNode;null!==b;)this.functionToApply(b.o),b=b.next;else this.functionToApply();return this},b.prototype.setID=function(a){return this.id=a,this},b.prototype.getUniqueId=function(){return this.id},a.RuleKey=b}(CassavaLight),function(a){var b=function(a,b){this.model=a,this.callback=b};b.prototype.createAgent=function(a,b){this.model.createAgent(a,b)},b.prototype.setTile=function(a,b){this.model.grid.setTile(a,b)},b.prototype.goToModel=function(a,b){this.model.goToModel(a,b)},b.prototype.getAgentById=function(a){return this.model.getAgentById(a)},b.prototype.gameGet=function(a){return this.model.game.get(a)},b.prototype.gameSet=function(a,b){this.model.game.set(a,b)},b.prototype.getInPostEvents=function(a,b){return this.model.getInPostEvents(a,b)},b.prototype.setInPostEvents=function(a,b,c){return this.model.setInPostEvents(a,b,c),this},b.prototype.refresh=function(){return this},b.prototype.apply=function(){return this.callback(),this},a.RuleNewFrame=b}(CassavaLight),function(a){var b=function(b){this.model=b,this.agents=new a.LinkedList,this.grid=this.model.grid,this.tilesList=[]};b.prototype.withAgentTypes=function(a){return this.agentTypes=a,this},b.prototype.withTiles=function(a){return this.tiles=a,this},b.prototype.so=function(a){return this.functionToApply=a,this},b.prototype.createAgent=function(a,b){this.model.createAgent(a,b)},b.prototype.setTile=function(a,b){this.model.grid.setTile(a,b)},b.prototype.goToModel=function(a,b){this.model.goToModel(a,b)},b.prototype.getAgentById=function(a){return this.model.getAgentById(a)},b.prototype.gameGet=function(a){return this.model.game.get(a)},b.prototype.gameSet=function(a,b){this.model.game.set(a,b)},b.prototype.getInPostEvents=function(a,b){return this.model.getInPostEvents(a,b)},b.prototype.setInPostEvents=function(a,b,c){return this.model.setInPostEvents(a,b,c),this},b.prototype.refresh=function(){return this.model.updateLogicBuffer(this.agents,this.agentTypes),this},b.prototype.apply=function(){var a,b,c;for(a=this.agents.firstNode;null!==a;){if(this.tilesList.length=0,this.model.agentHitsTiles(a.o,this.tiles,this.tilesList))for(c=0;c<this.tilesList.length;c++)b=this.tilesList[c],this.functionToApply(a.o,b);a=a.next}return this},b.prototype.setID=function(a){return this.id=a,this},b.prototype.getUniqueId=function(){return this.id},a.RuleTileCollision=b}(CassavaLight),function(a){var b=function(a,b,c,d,e,f){this.spriteSheet=a,this.spriteSheetWidth=b,this.spriteSheetHeight=c,this.sequences=d,this.numberOfFrames=e,this.frameTTL=f,this.sequences=null!=d?d:{},this.id=void 0,this.width=this.spriteSheetWidth/this.numberOfFrames,this.height=this.spriteSheetHeight,this.isRunning=!1,this.isLooping=!0,this.x=0,this.y=0,this.z=0,this.currentFrame=0,this.initialFrameTTL=this.frameTTL,this.sequences.default_seq={from:0,to:this.numberOfFrames-1},this.currentSequence="default_seq",this.imagePointerX=0,this.setInScope(!0),this.positionHasChanged=!1,this.goToCurrentFrame(),this.stop()};b.prototype.goToAndStop=function(a){return this.currentFrame=a,this.goToCurrentFrame(),this.isRunning=!1,this},b.prototype.stop=function(){return this.isRunning=!1,this},b.prototype.goToAndPlay=function(a){return this.currentFrame=a,this.goToCurrentFrame(),this.isRunning=!0,this},b.prototype.play=function(){return this.isRunning=!0,this},b.prototype.reset=function(){return this.currentFrame=0,this},b.prototype.draw=function(){return this.isRunning&&this.sequences[this.currentSequence].from!==this.sequences[this.currentSequence].to&&(this.frameTTL<=0&&(this.currentFrame>=this.numberOfFrames||this.currentFrame>=this.sequences[this.currentSequence].to?this.isLooping?this.currentFrame=this.sequences[this.currentSequence].from:this.stop():this.currentFrame++,this.goToCurrentFrame()),this.frameTTL--),this},b.prototype.goToCurrentFrame=function(){return this.frameTTL=this.initialFrameTTL,this.imagePointerX=this.currentFrame*this.width,this},b.prototype.goToSequence=function(a){return this.currentSequence!==a&&this.goToBeginningOfSequence(a),this},b.prototype.goToBeginningOfSequence=function(a){if(null==this.sequences[a])throw new Error("The sequence "+a+" is not defined.");return this.currentSequence=a,this.currentFrame=this.sequences[this.currentSequence].from,this.goToCurrentFrame(),this},b.prototype.setID=function(a){return this.id=a,this},b.prototype.getUniqueId=function(){return this.id},b.prototype.setPosition=function(a,b){return(this.x!==a||this.y!==b)&&(this.x=a,this.y=b,this.positionHasChanged=!0),this},b.prototype.setZIndex=function(a){return this.z=a,this},b.prototype.setInScope=function(a){return this.isInScope=a,this},a.SpriteCanvas=b}(CassavaLight),function(a){var b=Math.random,c=function(b){this.model=b,this.DEFAULT_TILE=0,this.grid=this.width=this.mapping=this.sequences=this.spriteSheet=this.totalFrames=this.tileWidth=this.tileHeight=this.frameTTL=null,this.updateGrid=[],this.spritesTiles=[],this.logicTiles=[],this.hasChangedGraphics=this.hasChangedLogic=!1,this.idManager=new a.IdManager("tileSprite"),this.Z_INDEX=0};c.prototype.withWidth=function(a){return this.width=a,this},c.prototype.withMapping=function(a){return this.mapping=a,this},c.prototype.withTilesTypes=function(a){return this.tilesTypes=a,this},c.prototype.withSequences=function(a){return this.sequences=a,this},c.prototype.withSpriteSheet=function(a){return this.spriteSheet=a,this},c.prototype.withTotalFrames=function(a){return this.totalFrames=a,this},c.prototype.withTileWidth=function(a){return this.tileWidth=a,this},c.prototype.withTileHeight=function(a){return this.tileHeight=a,this},c.prototype.withFrameTTL=function(a){return this.frameTTL=a,this},c.prototype.withAdapter=function(a){return this.adapter=a,this},c.prototype.initGrid=function(c){var d,e,f;if(this.grid=c,!a.exists(this.width))throw"Width has not been defined";if(!a.exists(this.sequences))throw"Sequences has not been defined";if(!a.exists(this.tilesTypes))throw"TilesTypes has not been defined";if(!a.exists(this.spriteSheet))throw"SpriteSheet has not been defined";if(!a.exists(this.totalFrames))throw"TotalFrames has not been defined";if(!a.exists(this.tileWidth))throw"TileWidth has not been defined";if(!a.exists(this.tileHeight))throw"TileHeight has not been defined";if(!a.exists(this.frameTTL))throw"FrameTTL has not been defined";if(c.length%this.width!==0)throw"Grid size "+this.grid.length+" must be "+this.width+" multiple";for(d=0;d<this.grid.length;++d)f=this.grid[d],this.grid[d]=f=f.toString(),a.exists(this.tilesTypes[f])?(e=this.model.getNewSprite(this.spriteSheet,this.tileWidth*this.totalFrames,this.tileHeight,this.sequences,this.totalFrames,this.frameTTL),e.setID(this.idManager.getNewID()).goToSequence(this.tilesTypes[f].sequence[~~(b()*this.tilesTypes[f].sequence.length)]).setPosition(this.getTileXInPixels(d),this.getTileYInPixels(d)).setZIndex(this.Z_INDEX).play(),this.model.addedAgentsSprites.add(e),this.spritesTiles[d]=e,this.logicTiles[d]={index:d,type:f,solid:this.tilesTypes[f].solid,x:this.getTileXInPixels(d),x2:this.getTileXInPixels(d)+this.tileWidth,y:this.getTileYInPixels(d),y2:this.getTileYInPixels(d)+this.tileHeight,sequence:this.adaptTile(d)}):(this.logicTiles[d]={solid:!1},this.spritesTiles[d]=null),this.updateGrid[d]=!0;return this.hasChangedLogic=this.hasChangedGraphics=!0,this},c.prototype.acknowledgeLogic=function(){var a,b;if(this.hasChangedLogic=!1,!this.hasChangedGraphics)for(b=0;b<this.updateGrid.length;b++)a=this.updateGrid[b],a=!1;return this},c.prototype.getTileX=function(a){return a%this.width},c.prototype.getTileXInPixels=function(a){return this.getTileX(a)*this.tileWidth},c.prototype.getTileY=function(b){return a.intValue(b/this.width)},c.prototype.getTileYInPixels=function(a){return this.getTileY(a)*this.tileHeight},c.prototype.getTileByCoordinates=function(b,c){var d=this.width*c+b;return a.exists(this.grid[d])?this.grid[d]:this.DEFAULT_TILE},c.prototype.getTopTile=function(a){return this.getTileByCoordinates(this.getTileX(a),this.getTileY(a)-1)},c.prototype.getTopLeftTile=function(a){return this.getTileByCoordinates(this.getTileX(a)-1,this.getTileY(a)-1)},c.prototype.getLeftTile=function(a){return this.getTileByCoordinates(this.getTileX(a)-1,this.getTileY(a))},c.prototype.getBottomLeftTile=function(a){return this.getTileByCoordinates(this.getTileX(a)-1,this.getTileY(a)+1)},c.prototype.getBottomTile=function(a){return this.getTileByCoordinates(this.getTileX(a),this.getTileY(a)+1)},c.prototype.getBottomRightTile=function(a){return this.getTileByCoordinates(this.getTileX(a)+1,this.getTileY(a)+1)},c.prototype.getRightTile=function(a){return this.getTileByCoordinates(this.getTileX(a)+1,this.getTileY(a))},c.prototype.getTopRightTile=function(a){return this.getTileByCoordinates(this.getTileX(a)+1,this.getTileY(a)-1)},c.prototype.getTileByIndex=function(a){return this.checkIndex(a),this.grid[a]},c.prototype.getLogicTileByIndex=function(a){return this.checkIndex(a),this.logicTiles[a]},c.prototype.setTile=function(a,b){return this.checkIndex(a),this.grid[a]=b,this.logicTiles[a].sequence=this.adaptTile(a),this.updateGrid[a]=!0,this.hasChangedGraphics=this.hasChangedLogic=!0,this},c.prototype.checkIndex=function(b){if(!a.exists(this.grid[b]))throw new Error("Grid out of bounds exception or have not been initialized")},c.prototype.draw=function(){var b,c;for(b=0;b<this.spritesTiles.length;++b)c=this.spritesTiles[b],1==this.updateGrid[b]&&(null!=c&&c.goToSequence(this.logicTiles[b].sequence),this.updateGrid[b]=!1),a.exists(c)&&c.draw();return this},c.prototype.adaptTile=function(a){if(this.adapter&&this.adapter[this.grid[a]])for(var c=0;c<this.adapter[this.grid[a]].length;++c)if(this.matchNeighbors(this.adapter[this.grid[a]][c].nearby,a))return this.adapter[this.grid[a]][c].sequence[~~(b()*this.adapter[this.grid[a]][c].sequence.length)];return this.tilesTypes[this.grid[a]].sequence[~~(b()*this.tilesTypes[this.grid[a]].sequence.length)]},c.prototype.matchNeighbors=function(a,b){var c,d;if("number"==typeof a[0]){if(this.getTopTile(b)!=a[0])return!1}else{for(d=!1,c=0;c<a[0].length;++c)if(this.getTopTile(b)==a[0][c]){d=!0;break}if(!d)return!1}if("number"==typeof a[1]){if(this.getBottomTile(b)!=a[1])return!1}else{for(d=!1,c=0;c<a[1].length;++c)if(this.getBottomTile(b)==a[1][c]){d=!0;break}if(!d)return!1}if("number"==typeof a[2]){if(this.getLeftTile(b)!=a[2])return!1}else{for(d=!1,c=0;c<a[2].length;++c)if(this.getLeftTile(b)==a[2][c]){d=!0;break}if(!d)return!1}if("number"==typeof a[3]){if(this.getRightTile(b)!=a[3])return!1}else{for(d=!1,c=0;c<a[3].length;++c)if(this.getRightTile(b)==a[3][c]){d=!0;break}if(!d)return!1}return!0},a.TilesGrid=c}(CassavaLight);var SuperLand=SuperLand||{};SuperLand.Functions=SuperLand.Functions||{},!function(a){a.Functions.AgentsInit={InitAgent:function(a,b){a.x=b.x,a.y=b.y,b.sequence&&a.sprite.goToSequence(b.sequence),b.weapon&&a.set("inventory","currentWeapon",b.weapon),b.health&&a.set("health","healthPoints",b.health),b.hit_stats&&a.set("hit_stats","damages",b.hit_stats)},InitSwordHit:function(a,b){var c=b.user,d=c.xCenter(),e=c.yCenter();switch(b.orientation){case"N":a.goToBeginningOfSequence("n").play(),a.x=d+13,a.y=e-45;break;case"E":a.goToBeginningOfSequence("e").play(),a.x=d+13,a.y=e+13;break;case"S":a.goToBeginningOfSequence("s").play(),a.x=d-45,a.y=e+13;break;case"W":a.goToBeginningOfSequence("w").play(),a.x=d-45,a.y=e-45}a.set("hit_manager","orientation",b.orientation),a.set("hit_manager","ttl",12),a.set("hit_manager","user",c),a.set("hit_stats","damages",1)}}}(SuperLand);var SuperLand=SuperLand||{};SuperLand.Functions=SuperLand.Functions||{},!function(a){a.Functions.EventsCallback={goLeft:function(a){a.get("colddowns","stand")<=0&&a.get("colddowns","projection")<=0&&a.set("physics","speedX",a.get("physics","speedX")-2)},goUp:function(a){a.get("colddowns","stand")<=0&&a.get("colddowns","projection")<=0&&a.set("physics","speedY",a.get("physics","speedY")-2)},goRight:function(a){a.get("colddowns","stand")<=0&&a.get("colddowns","projection")<=0&&a.set("physics","speedX",a.get("physics","speedX")+2)},goDown:function(a){a.get("colddowns","stand")<=0&&a.get("colddowns","projection")<=0&&a.set("physics","speedY",a.get("physics","speedY")+2)},playerHit:function(a){a.giveState("isHitting")},setCollisions:function(a,b){a.x<b.x&&a.set("agent_simple_collisions","leftCollisionRectangle",a.x2()-b.x),a.x2()>b.x2&&a.set("agent_simple_collisions","rightCollisionRectangle",b.x2-a.x),a.y<b.y&&a.set("agent_simple_collisions","topCollisionRectangle",a.y2()-b.y),a.y2()>b.y2&&a.set("agent_simple_collisions","bottomCollisionRectangle",b.y2-a.y)}}}(SuperLand);var SuperLand=SuperLand||{};SuperLand.Functions=SuperLand.Functions||{},!function(a){a.Functions.ModelsInit={InitDebug:function(a){a.graphicEngine.setStageStyle("color","#FFFFFF")}}}(SuperLand);var SuperLand=SuperLand||{};SuperLand.Functions=SuperLand.Functions||{},!function(a){a.Functions.ModulesUpdate={updatePhysics:function(){var a=this.datas.speedX,b=this.datas.speedY;this.agent.removeState("hasMoved"),this.agent.get("colddowns","projection")<=0&&this.agent.hasState("isProjected")&&this.agent.set("colddowns","projection",5),this.agent.removeState("isProjected"),this.agent.get("colddowns","projection")<=0&&(0>b&&0===a&&this.agent.giveState("facingUp").removeState("facingDown").removeState("facingLeft").removeState("facingRight"),b>0&&0===a&&this.agent.removeState("facingUp").giveState("facingDown").removeState("facingLeft").removeState("facingRight"),0===b&&0>a&&this.agent.removeState("facingUp").removeState("facingDown").giveState("facingLeft").removeState("facingRight"),0===b&&a>0&&this.agent.removeState("facingUp").removeState("facingDown").removeState("facingLeft").giveState("facingRight"),0>a&&(this.agent.giveState("hasMoved"),this.agent.hasState("facingUp")||this.agent.hasState("facingDown")||this.agent.giveState("facingLeft").removeState("facingRight")),a>0&&(this.agent.giveState("hasMoved"),this.agent.hasState("facingUp")||this.agent.hasState("facingDown")||this.agent.giveState("facingRight").removeState("facingLeft")),0>b&&(this.agent.giveState("hasMoved"),this.agent.hasState("facingRight")||this.agent.hasState("facingLeft")||this.agent.giveState("facingUp").removeState("facingDown")),b>0&&(this.agent.giveState("hasMoved"),this.agent.hasState("facingRight")||this.agent.hasState("facingLeft")||this.agent.giveState("facingDown").removeState("facingUp"))),this.agent.x+=a,this.agent.y+=b,this.agent.get("colddowns","projection")<=0&&(this.datas.speedX=0,this.datas.speedY=0)},updateInventory:function(){var a=this.getModel(),b=this.agent;b.hasState("isHitting")&&(b.removeState("isHitting"),"SWORD"===this.datas.currentWeapon&&b.get("colddowns","cd_hit")<=0&&(b.hasState("facingUp")?a.createAgent("SWORD_HIT",{orientation:"N",user:b}):b.hasState("facingDown")?a.createAgent("SWORD_HIT",{orientation:"S",user:b}):b.hasState("facingLeft")?a.createAgent("SWORD_HIT",{orientation:"W",user:b}):b.hasState("facingRight")?a.createAgent("SWORD_HIT",{orientation:"E",user:b}):a.createAgent("SWORD_HIT",{orientation:"S",user:b}),b.set("colddowns","cd_hit",20),b.set("colddowns","stand",20)))},updateHealth:function(){var a=this.agent;if((void 0===a.get("colddowns","invulnerability")||void 0!==a.get("colddowns","invulnerability")&&a.get("colddowns","invulnerability")<=0)&&a.hasState("tookDamages")){var b=this.datas.originX,c=this.datas.originY,d=this.datas.damages,e=this.agent.xCenter(),f=this.agent.yCenter(),g=e-b,h=f-c,i=Math.sqrt(g*g+h*h);a.giveState("isProjected"),a.set("physics","speedX",10*g/i),a.set("physics","speedY",10*h/i),a.set("colddowns","invulnerability",60),this.datas.healthPoints-=d,this.datas.healthPoints<=0&&this.agent.free()}a.removeState("tookDamages")},updateColddowns:function(){for(var a in this.datas)this.datas[a]>0&&this.datas[a]--},updateSwordHit:function(){var a=this.datas.user.xCenter(),b=this.datas.user.yCenter(),c=this.datas.orientation,d=this.datas.ttl;if(0>=d)return void this.agent.free();switch(c){case"N":this.agent.x=a+(d>8?13:-13),this.agent.y=b-45;break;case"S":this.agent.x=a-(d>8?45:13),this.agent.y=b+13;break;case"E":this.agent.x=a+13,this.agent.y=b+(d>8?13:-13);break;case"W":this.agent.x=a-48,this.agent.y=b-(d>8?45:13)}this.datas.ttl--},adaptSpriteSequence:function(){var a,b=this.datas.mapping,c=b.length;for(a=0;c>a;++a)if(this.agent.hasStates(b[a].states)){this.agent.goToSequence(b[a].sequence);break}},resolveBasicCollisions:function(){void 0===this.datas.agentList&&(this.datas.agentList=this.getModel().agents);var b,c,d=this.datas.resolvableAgents,e=d.length,f=this.datas.agentList;for(b=0;e>b;++b)if(void 0!==f[d[b]])for(c=f[d[b]].firstNode;null!==c;)a.Functions.Utils.resolveBasicCollision(c.o.modules.agent_simple_collisions),c=c.next},placeCameraOnPlayer:function(){void 0===this.datas.player&&(this.datas.player=this.getAgentById("PLAYER")),void 0!==this.camera()&&null!==this.datas.player&&this.camera().goTo(this.datas.player.x-147,this.datas.player.y-147)}}}(SuperLand);var SuperLand=SuperLand||{};SuperLand.Functions=SuperLand.Functions||{},!function(a){a.Functions.Utils={resolveBasicCollision:function(a){var b=a.datas.leftCollisionRectangle,c=a.datas.rightCollisionRectangle,d=a.datas.topCollisionRectangle,e=a.datas.bottomCollisionRectangle,f=a.agent,g=d>0,h=b>0,i=c>0,j=e>0;j?i?(h||g||(e>=c&&(f.x+=c),c>=e&&(f.y+=e)),h&&!g&&(f.y+=e),!h&&g&&(f.x+=c),h&&g&&(f.x+=b>c?c:-b,f.y+=e>d?-d:e)):(h&&g&&(f.x-=b),h&&!g&&(e>=b&&(f.x-=b),b>=e&&(f.y+=e)),h||g||(f.y+=e)):i?(h&&g&&(f.y-=d),!h&&g&&(d>=c&&(f.x+=c),c>=d&&(f.y-=d)),h||g||(f.x+=c)):(h&&g&&(d>=b&&(f.x-=b),b>=d&&(f.y-=d)),h&&!g&&(f.x-=b),!h&&g&&(f.y-=d)),a.datas.leftCollisionRectangle=a.datas.rightCollisionRectangle=a.datas.topCollisionRectangle=a.datas.bottomCollisionRectangle=0}}}(SuperLand);var SuperLand=SuperLand||{};!function(a){a.Events={keyLeftPressed:{type:"key",parameters:{key:"37",agents:["PLAYER"]},callback:a.Functions.EventsCallback.goLeft},keyUpPressed:{type:"key",parameters:{key:"38",agents:["PLAYER"]},callback:a.Functions.EventsCallback.goUp},keyRightPressed:{type:"key",parameters:{key:"39",agents:["PLAYER"]},callback:a.Functions.EventsCallback.goRight},keyDownPressed:{type:"key",parameters:{key:"40",agents:["PLAYER"]},callback:a.Functions.EventsCallback.goDown},keyHitPressed:{type:"key",parameters:{key:"88",agents:["PLAYER"]},callback:a.Functions.EventsCallback.playerHit},characterHitsSolidBlock:{type:"agentHitsTile",parameters:{agents:["PLAYER"],tiles:["38","41","15","16","17","30","28","20","21","22","23","7","6","40","44","42","43","45","18","19","39"]},callback:a.Functions.EventsCallback.setCollisions}}}(SuperLand);var SuperLand=SuperLand||{};!function(a){a.Modules={physics:{datas:{speedX:0,speedY:0},update:a.Functions.ModulesUpdate.updatePhysics},agent_simple_collisions:{datas:{leftCollision:0,rightCollision:0,topCollision:0,bottomCollision:0},update:void 0},inventory:{datas:{possibleWeapons:{NONE:0,SWORD:1},currentWeapon:"NONE"},update:a.Functions.ModulesUpdate.updateInventory},health:{datas:{healthPoints:0,damages:0,originX:void 0,originY:0},update:a.Functions.ModulesUpdate.updateHealth},hit_stats:{datas:{damages:0},update:void 0},sword_hit_manager:{datas:{ttl:void 0,orientation:void 0,user:void 0},update:a.Functions.ModulesUpdate.updateSwordHit},collisions_resolver:{datas:{agentList:void 0,resolvableAgents:["PLAYER"]},update:a.Functions.ModulesUpdate.resolveBasicCollisions},camera_centering:{datas:{player:void 0},update:a.Functions.ModulesUpdate.placeCameraOnPlayer}}}(SuperLand);var SuperLand=SuperLand||{};!function(a){a.Sprites={TS_Ville:{sequences:{1:{from:0,to:0},2:{from:1,to:1},3:{from:2,to:2},4:{from:3,to:3},5:{from:4,to:4},6:{from:5,to:5},7:{from:6,to:6},8:{from:7,to:7},9:{from:8,to:8},10:{from:9,to:9},11:{from:10,to:10},12:{from:11,to:11},13:{from:12,to:12},14:{from:13,to:13},15:{from:14,to:14},16:{from:15,to:15},17:{from:16,to:16},18:{from:17,to:17},19:{from:18,to:18},20:{from:19,to:19},21:{from:20,to:20},22:{from:21,to:21},23:{from:22,to:22},24:{from:23,to:23},25:{from:24,to:24},26:{from:25,to:25},27:{from:26,to:26},28:{from:27,to:27},29:{from:28,to:28},30:{from:29,to:29},31:{from:30,to:30},32:{from:31,to:31},33:{from:32,to:32},34:{from:33,to:33},35:{from:34,to:34},36:{from:35,to:35},37:{from:36,to:36},38:{from:37,to:37},39:{from:38,to:38},40:{from:39,to:39},41:{from:40,to:40},42:{from:41,to:41},43:{from:42,to:42},44:{from:43,to:43},45:{from:44,to:44},46:{from:45,to:45},47:{from:46,to:46},48:{from:47,to:47},49:{from:48,to:48},50:{from:49,to:49},51:{from:50,to:50},52:{from:51,to:51},53:{from:52,to:52},54:{from:53,to:54}},spriteSheet:"Assets/Img/TS_Ville.png",spriteWidth:32,spriteHeight:32,numberOfFrames:55,frameTTL:60},DebugPlayer:{sequences:{map:{from:0,to:0}},spriteSheet:"Assets/Img/debugplayer2626.png",numberOfFrames:1,spriteWidth:26,spriteHeight:26,frameTTL:1},Sword:{spriteSheet:"Assets/Img/sword.png",spriteWidth:32,spriteHeight:32,sequences:{n:{from:0,to:2},n1:{from:0,to:0},n2:{from:1,to:1},n3:{from:2,to:2},s:{from:3,to:5},s1:{from:3,to:3},s2:{from:4,to:4},s3:{from:5,to:5},w:{from:6,to:8},w1:{from:6,to:6},w2:{from:7,to:7},w3:{from:8,to:8},e:{from:9,to:11},e1:{from:9,to:9},e2:{from:10,to:10},e3:{from:11,to:11}},numberOfFrames:12,frameTTL:4}}}(SuperLand);var SuperLand=SuperLand||{};SuperLand.Agents=SuperLand.Agents||{},!function(a){a.Agents.Player={updateAnyways:!0,number:1,sprite:a.Sprites.DebugPlayer,datas:{x:0,y:0,z:1,width:26,height:26,rotation:0,spriteXDelta:0,spriteYDelta:0},solid:!0,animated:!1,modules:{physics:a.Modules.physics,agent_simple_collisions:a.Modules.agent_simple_collisions,inventory:a.Modules.inventory,health:a.Modules.health,colddowns:{datas:{cd_hit:0,stand:0,invulnerability:0,projection:0},update:a.Functions.ModulesUpdate.updateColddowns},spriteAdapter:{datas:{mapping:[{states:[],sequence:"map"}]},update:a.Functions.ModulesUpdate.adaptSpriteSequence}},initMethod:a.Functions.AgentsInit.InitAgent}}(SuperLand);var SuperLand=SuperLand||{};SuperLand.Agents=SuperLand.Agents||{},!function(a){a.Agents.SwordHit={number:2,sprite:a.Sprites.Sword,datas:{x:0,y:0,z:1,width:32,height:32,rotation:0,spriteXDelta:0,spriteYDelta:0},solid:!0,animated:!1,modules:{hit_manager:a.Modules.sword_hit_manager,hit_stats:a.Modules.hit_stats},initMethod:a.Functions.AgentsInit.InitSwordHit}}(SuperLand);var SuperLand=SuperLand||{};SuperLand.Maps=SuperLand.Maps||{},!function(a){a.Maps.Ville={name:"ville",camera:{modelInitialPosition:{x:0,y:0},displayDomainScale:1,logicDomainScale:1.3},collisionsChecker:{width:1e3,height:1e3,tileSide:100},gridConfig:{width:20,sprite:a.Sprites.TS_Ville,tilesTypes:{1:{solid:!0,sequence:[1,2]},3:{solid:!1,sequence:[3]},4:{solid:!0,sequence:[4]},5:{solid:!0,sequence:[5]},6:{solid:!0,sequence:[6]},7:{solid:!0,sequence:[7]},8:{solid:!0,sequence:[8]},9:{solid:!0,sequence:[9]},10:{solid:!0,sequence:[10]},11:{solid:!0,sequence:[11]},12:{solid:!0,sequence:[12]},13:{solid:!0,sequence:[13]},14:{solid:!0,sequence:[14]},15:{solid:!0,sequence:[15]},16:{solid:!0,sequence:[16]},17:{solid:!0,sequence:[17]},18:{solid:!0,sequence:[18]},19:{solid:!0,sequence:[19]},20:{solid:!0,sequence:[20]},21:{solid:!0,sequence:[21]},22:{solid:!0,sequence:[22]},23:{solid:!0,sequence:[23]},24:{solid:!0,sequence:[24]},25:{solid:!0,sequence:[25]},26:{solid:!0,sequence:[26]},27:{solid:!0,sequence:[27]},28:{solid:!0,sequence:[28]},29:{solid:!0,sequence:[29]},30:{solid:!0,sequence:[30,31]},32:{solid:!0,sequence:[32]},33:{solid:!0,sequence:[33]},34:{solid:!0,sequence:[34]},35:{solid:!0,sequence:[35]},36:{solid:!0,sequence:[36]},37:{solid:!0,sequence:[37]},38:{solid:!0,sequence:[38]},39:{solid:!0,sequence:[39]},40:{solid:!0,sequence:[40]},41:{solid:!0,sequence:[41]},42:{solid:!0,sequence:[42]},43:{solid:!0,sequence:[43]},44:{solid:!0,sequence:[44]},45:{solid:!0,sequence:[45]},46:{solid:!0,sequence:[46]},47:{solid:!0,sequence:[47]},48:{solid:!0,sequence:[48]},49:{solid:!0,sequence:[49]},50:{solid:!0,sequence:[50]},51:{solid:!0,sequence:[51]},52:{solid:!0,sequence:[52]},53:{solid:!0,sequence:[53]},54:{solid:!0,sequence:[54]}}},grid:[0,0,0,0,0,0,0,0,0,32,33,0,0,0,0,0,0,0,0,0,0,48,41,41,41,41,41,41,45,1,1,44,41,41,41,41,41,41,41,49,0,38,8,1,1,1,1,1,28,28,28,28,1,1,1,1,1,30,30,40,0,38,15,16,17,1,1,1,1,1,1,1,1,1,1,1,30,30,30,40,0,38,18,26,19,1,1,1,1,1,1,12,10,10,10,15,16,16,17,40,0,38,23,3,23,1,1,30,1,50,51,9,1,1,1,18,20,27,19,40,0,45,1,1,9,1,1,1,50,54,54,51,1,1,1,21,22,3,23,40,34,1,30,1,11,10,10,10,52,54,54,53,1,1,9,1,1,1,1,40,35,1,30,30,1,1,1,1,1,52,53,10,10,10,13,1,1,1,1,40,0,43,1,1,1,1,1,30,30,1,1,1,1,1,1,1,1,1,1,40,0,38,1,1,15,16,16,17,1,30,1,30,1,1,1,1,1,1,1,44,0,38,1,1,18,20,20,19,1,1,30,30,30,1,1,1,1,7,7,7,0,38,1,1,21,24,25,22,1,4,5,1,1,30,1,1,1,6,6,6,0,47,39,39,39,39,39,39,39,4,5,39,39,39,39,39,39,39,39,39,0,0,0,0,0,0,0,0,0,36,37,0,0,0,0,0,0,0,0,0],agents:{PLAYER:a.Agents.Player,SWORD_HIT:a.Agents.SwordHit},defaultAgents:[{notMandatory:!0,agentType:"PLAYER",datas:{x:96,y:66,health:3,weapon:"SWORD"}}],events:[a.Events.keyDownPressed,a.Events.keyUpPressed,a.Events.keyLeftPressed,a.Events.keyRightPressed,a.Events.keyHitPressed,a.Events.characterHitsSolidBlock],init:{initFunction:a.Functions.ModelsInit.InitDebug,parameters:{}},postEventsModules:{collisions_resolver:{datas:{agentList:void 0,resolvableAgents:["PLAYER"]},update:a.Functions.ModulesUpdate.resolveBasicCollisions},camera_centering:a.Modules.camera_centering}}}(SuperLand);var SuperLand=SuperLand||{};SuperLand.Maps=SuperLand.Maps||{},!function(a){a.Maps.TilesAdapter={}}(SuperLand);var SuperLand=SuperLand||{};!function(a,b){b.game=new a.Game(320,320),b.game.debug=!0,b.game.defineGraphicEngine("canvas").addModelConfig("Debug1",b.Maps.Debug1).addModelConfig("Debug2",b.Maps.Debug2).addModelConfig("ville",b.Maps.Ville).initState({}).loadModel("ville").run()}(CassavaLight,SuperLand);